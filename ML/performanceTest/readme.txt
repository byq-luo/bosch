checkout the diff.
there are some fundamental changes, however nothing that should make a performance comparison unfair.

the batch code is about 4 times faster than the non batch code.
